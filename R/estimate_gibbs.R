estimate_gibbs <- function(stan_data, iter, warmup, H, X_pred){
  library(MASS)
  library(LaplacesDemon)
  Z <- cbind(stan_data$W,stan_data$X)
  Y <- stan_data$Y
  X <- stan_data$X
  W <- stan_data$W
  Q <- stan_data$Q
  N <- stan_data$N
  k  <- stan_data$k
  p  <- stan_data$p
  q  <- stan_data$q
  n_iter <- iter
  beta_hat = solve((t(Z)%*%Z))%*%t(Z)%*%Y
  Gamma_d_OLS <- beta_hat[1:(k*p),]
  
  C_hat <- t(beta_hat[(k*p+1):(k*p+q),])
  A <- vector("list", p)
  for (i in 1:p) {
    rows_idx <- ((i - 1) * k + 1):(i * k)
    A[[i]] <- matrix(t(beta_hat[rows_idx, ]), nrow = k, ncol = k)
  }
  A_L <- diag(k)
  for (i in 1:p) {
    A_L <- A_L - A[[i]]
  }
  
  Lambda_OLS <- solve(A_L) %*% C_hat
  
  gamma_d_lbar <-  stan_data$vec_beta_0
  Sigma_d_lbar <- stan_data$Sigma_vec_beta
  
  lambda_lbar <- stan_data$vec_Psi_0
  Sigma_lambda_lbar <- stan_data$Sigma_vec_Psi
  
  
  Psi <- vector(mode = "list", length = n_iter)
  gamma_d <- vector(mode = "list", length = n_iter)
  lambda <- vector(mode = "list", length = n_iter)
  
  gamma_d[[1]] <- c(Gamma_d_OLS)
  lambda[[1]]  <- c(Lambda_OLS) 
  
  for (j in 2:n_iter){
    
    Lambda = matrix(lambda[[j-1]],k,q)
    Gamma_d = matrix(gamma_d[[j-1]],k*p,k)
    
    ############ EQ 29 ################
    U = Y - X%*%t(Lambda) - (W-Q%*%(diag(p) %x% t(Lambda))) %*% Gamma_d
    S = t(U)%*%U
    N = nrow(U)
    Psi[[j]] = rinvwishart(N, S)
    
    ############ EQ 30 ################
    Y_Lambda = Y-X%*%t(Lambda)
    W_Lambda = (W-Q%*%(diag(p)%x%t(Lambda)))
    
    Sigma_d_bar = solve((solve(Sigma_d_lbar)+solve(Psi[[j]]) %x% (t(W_Lambda) %*% W_Lambda)))
    
    gamma_d_bar = Sigma_d_bar %*% (solve(Sigma_d_lbar)%*%gamma_d_lbar + c(t(W_Lambda)%*%Y_Lambda%*%solve(Psi[[j]])))
    
    gamma_d[[j]] = mvrnorm(1, gamma_d_bar, Sigma_d_bar)
    
    ############ EQ 31 ################
    Gamma_d <- matrix(gamma_d[[j]],k*p,k)
    A_list <- vector("list", p)
    for (i in 1:p) {
      rows_idx <- ((i - 1) * k + 1):(i * k)
      A_list[[i]] <- t(Gamma_d[rows_idx, ])
    }
    blocks <- list(diag(k * q))
    for (i in 1:p) {
      blocks[[i + 1]] <- diag(q) %x% t(A_list[[i]])
    }
    F_prime <- do.call(cbind, blocks)
    F <- t(F_prime)
    
    B = cbind(X,-Q)
    Y_gamma = Y-W%*%Gamma_d
    
    Sigma_lambda_bar = solve(solve(Sigma_lambda_lbar)+t(F) %*% ((t(B)%*%B)%x%solve(Psi[[j]])) %*% F)
    lambda_bar = Sigma_lambda_bar %*% (solve(Sigma_lambda_lbar)%*%lambda_lbar+t(F)%*%c(solve(Psi[[j]])%*%t(Y_gamma)%*%B))
    
    lambda[[j]] <- mvrnorm(1, lambda_bar, Sigma_lambda_bar)
  }
  
  burnin <- warmup
  keep_idx <- seq(burnin + 1, n_iter)
  
  lambda_keep <- lambda[keep_idx]
  gamma_keep  <- gamma_d[keep_idx]
  Psi_keep    <- Psi[keep_idx]
  
  Gamma_d_post <- matrix(apply(simplify2array(gamma_keep), 1, mean), k * p, k)
  lambda_post  <- matrix(apply(simplify2array(lambda_keep), 1, mean), k, q)
  Psi_post     <- apply(simplify2array(Psi_keep), c(1,2), mean)
  
  n_draws <- length(lambda_keep)
  N <- nrow(Y)
  dummy = stan_data$dummy
  forecasts_array <- array(NA, dim = c(n_draws, H, k))
  
  for (j in seq_len(n_draws)) {
    Lambda <- matrix(lambda_keep[[j]], nrow = k, ncol = q)
    Gamma_d <- matrix(gamma_keep[[j]], nrow = k * p, ncol = k)
    Psi <- Psi_keep[[j]]                                    
    
    A <- vector("list", p)
    for (i in 1:p) {
      rows_idx <- ((i - 1) * k + 1):(i * k)
      A[[i]] <- t(Gamma_d[rows_idx,])  # k x k
    }
    
    Y_pred_mat <- matrix(NA, nrow = H, ncol = k)
    
    for (h in 1:H) {
      
      u_t <- mvrnorm(1, rep(0, k), Psi)
      yhat_t <- X_pred[h, ] %*% t(Lambda)
      
      if (h > 1) {
        for (i in 1:min(h - 1, p)) {
          term <- (Y_pred_mat[h - i,] - X_pred[h - i,] %*% t(Lambda)) %*% t(A[[i]])
          yhat_t <- yhat_t + term
        }
      }
      
      if (h <= p) {
        for (i in h:p) {
          term <- (Y[N + h - i,] - X[N + h - i,] %*% t(Lambda)) %*% t(A[[i]])
          yhat_t <- yhat_t + term
        }
      }
      
      Y_pred_mat[h, ] <- yhat_t + u_t
    }
    
    forecasts_array[j, ,] <- Y_pred_mat
  }
  list(fcst_draws = forecasts_array,
       beta_post_mean=Gamma_d_post,
       Psi_post_mean=lambda_post,
       Sigma_u_post_mean = Psi_post)
}
